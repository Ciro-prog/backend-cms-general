<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .drag-over { border-color: #3b82f6; background-color: #eff6ff; }
        .field-item { transition: all 0.2s ease; }
        .field-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .nested-indicator { border-left: 3px solid #e5e7eb; padding-left: 1rem; margin-left: 0.5rem; }
        .mapping-line { stroke: #3b82f6; stroke-width: 2; fill: none; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="/api-management" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <h1 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-magic text-blue-600 mr-2"></i>
                        Configurar Nueva API
                    </h1>
                </div>
                <div class="text-sm text-gray-500">
                    <i class="fas fa-user mr-1"></i>{{ request.session.get('user_name', 'Usuario') }}
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="flex items-center justify-center mb-8">
            <div class="flex items-center space-x-4">
                <!-- Step 1: Conexión -->
                <div class="flex items-center">
                    <div id="step1-circle" class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-medium">
                        1
                    </div>
                    <div class="ml-2 text-sm">
                        <div class="font-medium text-gray-900">Conexión API</div>
                        <div class="text-gray-500">Configurar y probar</div>
                    </div>
                </div>
                
                <div class="w-8 h-px bg-gray-300"></div>
                
                <!-- Step 2: Mapping -->
                <div class="flex items-center">
                    <div id="step2-circle" class="w-8 h-8 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center text-sm font-medium">
                        2
                    </div>
                    <div class="ml-2 text-sm">
                        <div class="font-medium text-gray-500">Mapping de Campos</div>
                        <div class="text-gray-400">Manual o automático</div>
                    </div>
                </div>
                
                <div class="w-8 h-px bg-gray-300"></div>
                
                <!-- Step 3: Preview -->
                <div class="flex items-center">
                    <div id="step3-circle" class="w-8 h-8 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center text-sm font-medium">
                        3
                    </div>
                    <div class="ml-2 text-sm">
                        <div class="font-medium text-gray-500">Preview</div>
                        <div class="text-gray-400">Verificar y guardar</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 1: Configuración API -->
        <div id="step1-content" class="fade-in">
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-6 border-b">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-plug text-blue-600 mr-2"></i>
                        Configuración de Conexión API
                    </h2>
                    <p class="text-gray-600 mt-1">Configura los parámetros de conexión a la API externa</p>
                </div>

                <div class="p-6">
                    <form id="apiConfigForm" class="space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Información básica -->
                            <div class="space-y-4">
                                <h3 class="font-medium text-gray-900">Información Básica</h3>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Nombre de la API *
                                    </label>
                                    <input type="text" id="apiName" name="name" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="ej: API Clientes CRM">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Business *
                                    </label>
                                    <select id="businessId" name="business_id" required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Seleccionar business...</option>
                                        {% for business in businesses %}
                                        <option value="{{ business.id }}">{{ business.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        URL Base *
                                    </label>
                                    <input type="url" id="baseUrl" name="base_url" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="https://api.ejemplo.com">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Endpoint *
                                    </label>
                                    <input type="text" id="endpoint" name="endpoint" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="/api/v1/clientes">
                                </div>
                            </div>

                            <!-- Configuración avanzada -->
                            <div class="space-y-4">
                                <h3 class="font-medium text-gray-900">Configuración Avanzada</h3>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Método HTTP
                                    </label>
                                    <select id="method" name="method"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                        <option value="GET">GET</option>
                                        <option value="POST">POST</option>
                                        <option value="PUT">PUT</option>
                                        <option value="DELETE">DELETE</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Headers (JSON)
                                    </label>
                                    <textarea id="headers" name="headers" rows="3"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                              placeholder='{"Authorization": "Bearer token", "Content-Type": "application/json"}'>{}</textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Parámetros (JSON)
                                    </label>
                                    <textarea id="params" name="params" rows="3"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                              placeholder='{"limit": 100, "status": "active"}'>{}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- URL Preview -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-eye mr-1"></i>
                                Preview de URL
                            </label>
                            <div id="urlPreview" class="font-mono text-sm text-gray-600 bg-white p-2 rounded border">
                                Completa los campos para ver el preview
                            </div>
                        </div>

                        <!-- Test Connection -->
                        <div class="flex items-center justify-between">
                            <button type="button" onclick="testConnection()" 
                                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                                <i class="fas fa-play"></i>
                                <span>Probar Conexión</span>
                            </button>
                            
                            <button type="button" onclick="goToStep(2)" disabled id="nextStep1"
                                    class="bg-gray-300 text-gray-500 px-6 py-2 rounded-lg cursor-not-allowed flex items-center space-x-2">
                                <span>Siguiente: Mapping</span>
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </form>

                    <!-- Test Results -->
                    <div id="testResults" class="hidden mt-6 p-4 rounded-lg border">
                        <!-- Los resultados se insertarán aquí dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Mapping de Campos -->
        <div id="step2-content" class="hidden">
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-6 border-b">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-sitemap text-blue-600 mr-2"></i>
                                Mapping de Campos
                            </h2>
                            <p class="text-gray-600 mt-1">Mapea los campos de la API a campos de tu entidad</p>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="autoMapFields()" 
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center space-x-2">
                                <i class="fas fa-magic"></i>
                                <span>Auto-Mapear</span>
                            </button>
                            <button onclick="clearMapping()" 
                                    class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 flex items-center space-x-2">
                                <i class="fas fa-eraser"></i>
                                <span>Limpiar</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <!-- Mapping Type Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Tipo de Mapping</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="mappingType" value="automatic" checked
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm">Automático (usar sugerencias)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="mappingType" value="manual"
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm">Manual (personalizado)</span>
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Campos API Detectados -->
                        <div>
                            <h3 class="font-medium text-gray-900 mb-4">
                                <i class="fas fa-database text-blue-600 mr-2"></i>
                                Campos Detectados en API
                            </h3>
                            <div id="detectedFields" class="space-y-2 bg-gray-50 rounded-lg p-4 min-h-64">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-search text-3xl mb-2"></i>
                                    <p>Realiza el test de conexión primero</p>
                                </div>
                            </div>
                        </div>

                        <!-- Campos Mapeados -->
                        <div>
                            <h3 class="font-medium text-gray-900 mb-4">
                                <i class="fas fa-layer-group text-green-600 mr-2"></i>
                                Campos de la Entidad
                            </h3>
                            <div id="mappedFields" class="space-y-2 bg-gray-50 rounded-lg p-4 min-h-64">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-plus text-3xl mb-2"></i>
                                    <p>Los campos mapeados aparecerán aquí</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Field Configuration Panel -->
                    <div id="fieldConfigPanel" class="hidden mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h4 class="font-medium text-blue-900 mb-3">
                            <i class="fas fa-cog mr-2"></i>
                            Configurar Campo: <span id="configFieldName"></span>
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-blue-700 mb-1">Nombre Amigable</label>
                                <input type="text" id="configDisplayName" 
                                       class="w-full px-3 py-1 text-sm border border-blue-300 rounded focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-blue-700 mb-1">Tipo de Datos</label>
                                <select id="configFieldType" 
                                        class="w-full px-3 py-1 text-sm border border-blue-300 rounded focus:ring-blue-500 focus:border-blue-500">
                                    <option value="text">Texto</option>
                                    <option value="number">Número</option>
                                    <option value="email">Email</option>
                                    <option value="phone">Teléfono</option>
                                    <option value="date">Fecha</option>
                                    <option value="boolean">Sí/No</option>
                                    <option value="url">URL</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-blue-700 mb-1">Visualización</label>
                                <div class="space-y-1">
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" id="configShowTable" class="mr-1 text-blue-600">
                                        <span>Mostrar en tabla</span>
                                    </label>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" id="configShowCard" class="mr-1 text-blue-600">
                                        <span>Mostrar en card</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-end space-x-2">
                                <button onclick="saveFieldConfig()" 
                                        class="bg-blue-600 text-white px-3 py-1 text-sm rounded hover:bg-blue-700">
                                    Guardar
                                </button>
                                <button onclick="closeFieldConfig()" 
                                        class="bg-gray-500 text-white px-3 py-1 text-sm rounded hover:bg-gray-600">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="flex items-center justify-between mt-8">
                        <button type="button" onclick="goToStep(1)" 
                                class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 flex items-center space-x-2">
                            <i class="fas fa-arrow-left"></i>
                            <span>Anterior</span>
                        </button>
                        
                        <div class="text-sm text-gray-600">
                            <span id="mappedCount">0</span> campos mapeados
                        </div>
                        
                        <button type="button" onclick="goToStep(3)" disabled id="nextStep2"
                                class="bg-gray-300 text-gray-500 px-6 py-2 rounded-lg cursor-not-allowed flex items-center space-x-2">
                            <span>Siguiente: Preview</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Preview y Guardar -->
        <div id="step3-content" class="hidden">
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-6 border-b">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-eye text-blue-600 mr-2"></i>
                                Preview de Datos
                            </h2>
                            <p class="text-gray-600 mt-1">Verifica cómo se verán los datos con tu configuración</p>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="refreshPreview()" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                                <i class="fas fa-sync"></i>
                                <span>Actualizar</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <!-- View Type Selector -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Tipo de Visualización</label>
                        <div class="flex space-x-4">
                            <button onclick="changePreviewType('table')" id="viewTable"
                                    class="px-4 py-2 rounded-lg border border-blue-600 bg-blue-600 text-white hover:bg-blue-700">
                                <i class="fas fa-table mr-2"></i>Tabla
                            </button>
                            <button onclick="changePreviewType('cards')" id="viewCards"
                                    class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">
                                <i class="fas fa-th-large mr-2"></i>Cards
                            </button>
                            <button onclick="changePreviewType('chart')" id="viewChart"
                                    class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">
                                <i class="fas fa-chart-bar mr-2"></i>Gráfico
                            </button>
                        </div>
                    </div>

                    <!-- Preview Container -->
                    <div id="previewContainer" class="min-h-96 bg-gray-50 rounded-lg p-4">
                        <div class="text-center text-gray-500 py-12">
                            <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                            <p>Generando preview...</p>
                        </div>
                    </div>

                    <!-- Configuration Summary -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-3">
                            <i class="fas fa-list mr-2"></i>
                            Resumen de Configuración
                        </h4>
                        <div id="configSummary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>

                    <!-- Final Actions -->
                    <div class="flex items-center justify-between mt-8">
                        <button type="button" onclick="goToStep(2)" 
                                class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 flex items-center space-x-2">
                            <i class="fas fa-arrow-left"></i>
                            <span>Anterior</span>
                        </button>
                        
                        <div class="flex space-x-4">
                            <button type="button" onclick="exportConfig()" 
                                    class="bg-yellow-600 text-white px-6 py-2 rounded-lg hover:bg-yellow-700 flex items-center space-x-2">
                                <i class="fas fa-download"></i>
                                <span>Exportar Config</span>
                            </button>
                            
                            <button type="button" onclick="saveConfiguration()" 
                                    class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 flex items-center space-x-2">
                                <i class="fas fa-save"></i>
                                <span>Guardar API</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <div class="text-center">
                <i class="fas fa-check-circle text-5xl text-green-600 mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">¡API Configurada Exitosamente!</h3>
                <p class="text-gray-600 mb-6" id="successMessage">Tu API ha sido configurada y guardada correctamente.</p>
                <div class="flex space-x-4">
                    <button onclick="goToApiManagement()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        Ver APIs Configuradas
                    </button>
                    <button onclick="createAnother()" 
                            class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        Configurar Otra
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', path='/enhanced_wizard.js') }}"></script>
</body>
</html>
