# ================================
# ARCHIVO: app/frontend/templates/business_types/businesses.html
# RUTA: app/frontend/templates/business_types/businesses.html
# ================================

{% extends "base.html" %}

{% block title %}Business Instances - CMS Dinámico{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                Business Instances
            </h2>
            <p class="text-sm text-gray-500 mt-1">
                Gestiona las instancias específicas de cada tipo de negocio
            </p>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
            <button onclick="showCreateModal()" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i>
                Nueva Business Instance
            </button>
        </div>
    </div>

    <!-- Business Instances List -->
    <div class="bg-white shadow overflow-hidden sm:rounded-md">
        <div class="px-4 py-5 sm:p-6">
            <div id="businesses-container">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                    <p class="text-gray-500">Cargando business instances...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="businessModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="modal-title">
                    Crear Business Instance
                </h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="businessForm" onsubmit="saveBusiness(event)">
                <input type="hidden" id="editingId" value="">
                
                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                        Nombre *
                    </label>
                    <input type="text" id="name" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Ej: TelcoNorte ISP">
                </div>
                
                <div class="mb-4">
                    <label for="business_type_id" class="block text-sm font-medium text-gray-700 mb-2">
                        Business Type *
                    </label>
                    <select id="business_type_id" name="business_type_id" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccionar tipo...</option>
                    </select>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Configuración de Branding
                    </label>
                    <div class="space-y-3">
                        <div>
                            <label for="primary_color" class="block text-xs text-gray-600">Color Primario</label>
                            <input type="color" id="primary_color" value="#2563eb"
                                   class="w-full h-10 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="logo_url" class="block text-xs text-gray-600">URL del Logo</label>
                            <input type="url" id="logo_url" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="https://example.com/logo.png">
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" id="saveButton"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        <span id="saveButtonText">Crear</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let businesses = [];
let businessTypes = [];

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadBusinessTypes();
    loadBusinesses();
});

async function loadBusinessTypes() {
    try {
        const response = await fetch('/api/admin/business-types');
        const data = await response.json();
        
        if (data.success) {
            businessTypes = data.data;
            
            const select = document.getElementById('business_type_id');
            select.innerHTML = '<option value="">Seleccionar tipo...</option>';
            
            businessTypes.forEach(bt => {
                const option = document.createElement('option');
                option.value = bt.business_type_id;
                option.textContent = bt.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading business types:', error);
    }
}

async function loadBusinesses() {
    const container = document.getElementById('businesses-container');
    
    try {
        const response = await fetch('/api/admin/businesses');
        const data = await response.json();
        
        if (data.success) {
            businesses = data.data;
            renderBusinesses();
        } else {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-circle text-red-400 text-2xl mb-2"></i>
                    <p class="text-red-600">Error: ${data.message || 'No se pudieron cargar las businesses'}</p>
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-yellow-400 text-2xl mb-2"></i>
                <p class="text-yellow-600">Error de conexión: ${error.message}</p>
            </div>
        `;
    }
}

function renderBusinesses() {
    const container = document.getElementById('businesses-container');
    
    if (businesses.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-building text-gray-400 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No hay Business Instances</h3>
                <p class="text-gray-500 mb-4">Crea tu primera instancia de negocio</p>
                <button onclick="showCreateModal()" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>
                    Crear Business Instance
                </button>
            </div>
        `;
        return;
    }
    
    const html = businesses.map(business => {
        const businessType = businessTypes.find(bt => bt.business_type_id === business.business_type_id);
        const typeName = businessType ? businessType.name : 'Tipo no encontrado';
        
        return `
            <div class="border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h3 class="text-lg font-medium text-gray-900">${business.name}</h3>
                        <p class="text-sm text-gray-500 mt-1">Tipo: ${typeName}</p>
                        <div class="mt-2">
                            <span class="px-2 py-1 text-xs rounded-full ${business.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${business.status === 'active' ? 'Activo' : 'Inactivo'}
                            </span>
                            <span class="ml-2 text-xs text-gray-500">
                                ${business.active_components?.length || 0} componentes activos
                            </span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editBusiness('${business.business_id}')" 
                                class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteBusiness('${business.business_id}')" 
                                class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                ${business.branding && Object.keys(business.branding).length > 0 ? `
                    <div class="mt-3 border-t border-gray-200 pt-3">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Branding:</h4>
                        <div class="flex items-center space-x-4 text-xs text-gray-600">
                            ${business.branding.primary_color ? `
                                <div class="flex items-center">
                                    <div class="w-4 h-4 rounded border mr-1" style="background-color: ${business.branding.primary_color}"></div>
                                    Color: ${business.branding.primary_color}
                                </div>
                            ` : ''}
                            ${business.branding.logo_url ? `
                                <div>Logo configurado</div>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

function showCreateModal() {
    document.getElementById('modal-title').textContent = 'Crear Business Instance';
    document.getElementById('saveButtonText').textContent = 'Crear';
    document.getElementById('editingId').value = '';
    document.getElementById('businessForm').reset();
    document.getElementById('primary_color').value = '#2563eb';
    document.getElementById('businessModal').classList.remove('hidden');
}

function editBusiness(businessId) {
    const business = businesses.find(b => b.business_id === businessId);
    if (!business) return;
    
    document.getElementById('modal-title').textContent = 'Editar Business Instance';
    document.getElementById('saveButtonText').textContent = 'Actualizar';
    document.getElementById('editingId').value = businessId;
    document.getElementById('name').value = business.name;
    document.getElementById('business_type_id').value = business.business_type_id;
    
    // Set branding
    if (business.branding) {
        document.getElementById('primary_color').value = business.branding.primary_color || '#2563eb';
        document.getElementById('logo_url').value = business.branding.logo_url || '';
    }
    
    document.getElementById('businessModal').classList.remove('hidden');
}

async function saveBusiness(event) {
    event.preventDefault();
    
    const saveButton = document.getElementById('saveButton');
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
    saveButton.disabled = true;
    
    try {
        const formData = new FormData(event.target);
        const editingId = document.getElementById('editingId').value;
        
        const data = {
            name: formData.get('name'),
            business_type_id: formData.get('business_type_id'),
            branding: {
                primary_color: document.getElementById('primary_color').value,
                logo_url: document.getElementById('logo_url').value || null
            },
            active_components: [] // Se configurará después
        };
        
        const url = editingId 
            ? `/api/admin/businesses/${editingId}`
            : '/api/admin/businesses';
        
        const method = editingId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeModal();
            loadBusinesses(); // Reload the list
            
            // Show success message
            showMessage('success', editingId ? 'Business Instance actualizada exitosamente' : 'Business Instance creada exitosamente');
        } else {
            throw new Error(result.message || 'Error al guardar');
        }
        
    } catch (error) {
        showMessage('error', `Error: ${error.message}`);
    } finally {
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
    }
}

async function deleteBusiness(businessId) {
    if (!confirm('¿Estás seguro de que quieres eliminar esta Business Instance?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/businesses/${businessId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            loadBusinesses(); // Reload the list
            showMessage('success', 'Business Instance eliminada exitosamente');
        } else {
            throw new Error(result.message || 'Error al eliminar');
        }
        
    } catch (error) {
        showMessage('error', `Error: ${error.message}`);
    }
}

function closeModal() {
    document.getElementById('businessModal').classList.add('hidden');
}

function showMessage(type, text) {
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `flash-message mb-4 px-4 py-3 rounded ${
        type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' : 
        'bg-green-100 border border-green-400 text-green-700'
    }`;
    messageDiv.textContent = text;
    
    // Insert at top of content
    const content = document.querySelector('.space-y-6');
    content.insertBefore(messageDiv, content.firstChild);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        messageDiv.style.opacity = '0';
        setTimeout(() => messageDiv.remove(), 500);
    }, 5000);
}

// Close modal when clicking outside
document.getElementById('businessModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}