<!-- ================================ -->
<!-- app/frontend/templates/business_types/list.html -->
<!-- ================================ -->

{% extends "base.html" %}

{% block title %}Business Types - CMS Dinámico{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                Business Types
            </h2>
            <p class="text-sm text-gray-500 mt-1">
                Gestiona los templates de tipos de negocio
            </p>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
            <button onclick="showCreateModal()" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i>
                Nuevo Business Type
            </button>
        </div>
    </div>

    <!-- Business Types List -->
    <div class="bg-white shadow overflow-hidden sm:rounded-md">
        <div class="px-4 py-5 sm:p-6">
            <div id="business-types-container">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                    <p class="text-gray-500">Cargando business types...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="businessTypeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="modal-title">
                    Crear Business Type
                </h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="businessTypeForm" onsubmit="saveBusinessType(event)">
                <input type="hidden" id="editingId" value="">
                
                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                        Nombre *
                    </label>
                    <input type="text" id="name" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Ej: ISP Provider, Clínica Médica">
                </div>
                
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        Descripción
                    </label>
                    <textarea id="description" name="description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Descripción del tipo de negocio"></textarea>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Componentes Disponibles
                    </label>
                    <div class="space-y-2" id="components-list">
                        <div class="flex items-center">
                            <input type="checkbox" id="comp-table" class="component-checkbox" 
                                   data-type="table" data-name="Tabla de Datos">
                            <label for="comp-table" class="ml-2 text-sm text-gray-700">
                                <i class="fas fa-table mr-1"></i> Tabla de Datos
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="comp-dashboard" class="component-checkbox"
                                   data-type="dashboard" data-name="Dashboard de Métricas">
                            <label for="comp-dashboard" class="ml-2 text-sm text-gray-700">
                                <i class="fas fa-tachometer-alt mr-1"></i> Dashboard de Métricas
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="comp-chart" class="component-checkbox"
                                   data-type="chart" data-name="Gráficos">
                            <label for="comp-chart" class="ml-2 text-sm text-gray-700">
                                <i class="fas fa-chart-bar mr-1"></i> Gráficos
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="comp-cards" class="component-checkbox"
                                   data-type="cards" data-name="Vista de Cards">
                            <label for="comp-cards" class="ml-2 text-sm text-gray-700">
                                <i class="fas fa-th-large mr-1"></i> Vista de Cards
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" id="saveButton"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        <span id="saveButtonText">Crear</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.btn {
    @apply px-4 py-2 rounded-md font-medium focus:outline-none focus:ring-2 focus:ring-offset-2;
}

.btn-primary {
    @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500;
}

.btn-secondary {
    @apply bg-gray-200 text-gray-900 hover:bg-gray-300 focus:ring-gray-500;
}

.btn-danger {
    @apply bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
}
</style>

<script>
let businessTypes = [];

// Load business types on page load
document.addEventListener('DOMContentLoaded', function() {
    loadBusinessTypes();
});

async function loadBusinessTypes() {
    const container = document.getElementById('business-types-container');
    
    try {
        const response = await fetch('/api/admin/business-types');
        const data = await response.json();
        
        if (data.success) {
            businessTypes = data.data;
            renderBusinessTypes();
        } else {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-circle text-red-400 text-2xl mb-2"></i>
                    <p class="text-red-600">Error: ${data.message || 'No se pudieron cargar los business types'}</p>
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-yellow-400 text-2xl mb-2"></i>
                <p class="text-yellow-600">Error de conexión: ${error.message}</p>
            </div>
        `;
    }
}

function renderBusinessTypes() {
    const container = document.getElementById('business-types-container');
    
    if (businessTypes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-shapes text-gray-400 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No hay Business Types</h3>
                <p class="text-gray-500 mb-4">Crea tu primer Business Type para comenzar</p>
                <button onclick="showCreateModal()" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>
                    Crear Business Type
                </button>
            </div>
        `;
        return;
    }
    
    const html = businessTypes.map(bt => `
        <div class="border border-gray-200 rounded-lg p-4 mb-4">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <h3 class="text-lg font-medium text-gray-900">${bt.name}</h3>
                    <p class="text-sm text-gray-500 mt-1">${bt.description || 'Sin descripción'}</p>
                    <div class="mt-2">
                        <span class="px-2 py-1 text-xs rounded-full ${bt.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${bt.status === 'active' ? 'Activo' : 'Inactivo'}
                        </span>
                        <span class="ml-2 text-xs text-gray-500">
                            ${bt.available_components?.length || 0} componentes disponibles
                        </span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="editBusinessType('${bt.business_type_id}')" 
                            class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteBusinessType('${bt.business_type_id}')" 
                            class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            ${bt.available_components?.length > 0 ? `
                <div class="mt-3 border-t border-gray-200 pt-3">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Componentes:</h4>
                    <div class="flex flex-wrap gap-2">
                        ${bt.available_components.map(comp => `
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">
                                <i class="fas fa-${getComponentIcon(comp.type)} mr-1"></i>
                                ${comp.name}
                            </span>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    `).join('');
    
    container.innerHTML = html;
}

function getComponentIcon(type) {
    const icons = {
        'table': 'table',
        'dashboard': 'tachometer-alt',
        'chart': 'chart-bar',
        'cards': 'th-large',
        'list': 'list',
        'metric': 'calculator'
    };
    return icons[type] || 'puzzle-piece';
}

function showCreateModal() {
    document.getElementById('modal-title').textContent = 'Crear Business Type';
    document.getElementById('saveButtonText').textContent = 'Crear';
    document.getElementById('editingId').value = '';
    document.getElementById('businessTypeForm').reset();
    
    // Uncheck all components
    document.querySelectorAll('.component-checkbox').forEach(cb => cb.checked = false);
    
    document.getElementById('businessTypeModal').classList.remove('hidden');
}

function editBusinessType(businessTypeId) {
    const bt = businessTypes.find(b => b.business_type_id === businessTypeId);
    if (!bt) return;
    
    document.getElementById('modal-title').textContent = 'Editar Business Type';
    document.getElementById('saveButtonText').textContent = 'Actualizar';
    document.getElementById('editingId').value = businessTypeId;
    document.getElementById('name').value = bt.name;
    document.getElementById('description').value = bt.description || '';
    
    // Check components
    document.querySelectorAll('.component-checkbox').forEach(cb => {
        const componentType = cb.dataset.type;
        cb.checked = bt.available_components?.some(comp => comp.type === componentType) || false;
    });
    
    document.getElementById('businessTypeModal').classList.remove('hidden');
}

async function saveBusinessType(event) {
    event.preventDefault();
    
    const saveButton = document.getElementById('saveButton');
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
    saveButton.disabled = true;
    
    try {
        const formData = new FormData(event.target);
        const editingId = document.getElementById('editingId').value;
        
        // Get selected components
        const selectedComponents = [];
        document.querySelectorAll('.component-checkbox:checked').forEach(cb => {
            selectedComponents.push({
                component_id: `${cb.dataset.type}_${Date.now()}`,
                name: cb.dataset.name,
                type: cb.dataset.type,
                description: `Componente ${cb.dataset.name}`,
                is_required: cb.dataset.type === 'table', // Table is required by default
                default_config: {}
            });
        });
        
        const data = {
            name: formData.get('name'),
            description: formData.get('description'),
            available_components: selectedComponents
        };
        
        const url = editingId 
            ? `/api/admin/business-types/${editingId}`
            : '/api/admin/business-types';
        
        const method = editingId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeModal();
            loadBusinessTypes(); // Reload the list
            
            // Show success message
            showMessage('success', editingId ? 'Business Type actualizado exitosamente' : 'Business Type creado exitosamente');
        } else {
            throw new Error(result.message || 'Error al guardar');
        }
        
    } catch (error) {
        showMessage('error', `Error: ${error.message}`);
    } finally {
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
    }
}

async function deleteBusinessType(businessTypeId) {
    if (!confirm('¿Estás seguro de que quieres eliminar este Business Type?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/business-types/${businessTypeId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            loadBusinessTypes(); // Reload the list
            showMessage('success', 'Business Type eliminado exitosamente');
        } else {
            throw new Error(result.message || 'Error al eliminar');
        }
        
    } catch (error) {
        showMessage('error', `Error: ${error.message}`);
    }
}

function closeModal() {
    document.getElementById('businessTypeModal').classList.add('hidden');
}

function showMessage(type, text) {
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `flash-message mb-4 px-4 py-3 rounded ${
        type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' : 
        'bg-green-100 border border-green-400 text-green-700'
    }`;
    messageDiv.textContent = text;
    
    // Insert at top of content
    const content = document.querySelector('.space-y-6');
    content.insertBefore(messageDiv, content.firstChild);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        messageDiv.style.opacity = '0';
        setTimeout(() => messageDiv.remove(), 500);
    }, 5000);
}

// Close modal when clicking outside
document.getElementById('businessTypeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}