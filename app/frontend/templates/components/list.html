<!-- ================================ -->
<!-- ARCHIVO: app/frontend/templates/components/list.html -->
<!-- RUTA: app/frontend/templates/components/list.html -->
<!-- ================================ -->

{% extends "base.html" %}

{% block title %}Dynamic Components - CMS Dinámico{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                Dynamic Components
            </h2>
            <p class="text-sm text-gray-500 mt-1">
                Gestiona los componentes dinámicos que consumen APIs externas
            </p>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
            <button onclick="showCreateModal()" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i>
                Nuevo Componente
            </button>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8" id="component-tabs">
            <button onclick="filterComponents('all')" class="tab-button active" data-filter="all">
                <i class="fas fa-th mr-2"></i>
                Todos
            </button>
            <button onclick="filterComponents('table')" class="tab-button" data-filter="table">
                <i class="fas fa-table mr-2"></i>
                Tablas
            </button>
            <button onclick="filterComponents('chart')" class="tab-button" data-filter="chart">
                <i class="fas fa-chart-bar mr-2"></i>
                Gráficos
            </button>
            <button onclick="filterComponents('dashboard')" class="tab-button" data-filter="dashboard">
                <i class="fas fa-tachometer-alt mr-2"></i>
                Dashboards
            </button>
        </nav>
    </div>

    <!-- Components Grid -->
    <div class="bg-white shadow overflow-hidden sm:rounded-md">
        <div class="px-4 py-5 sm:p-6">
            <div id="components-container">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                    <p class="text-gray-500">Cargando componentes dinámicos...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Component Modal -->
<div id="componentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white max-h-screen overflow-y-auto">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    Crear Dynamic Component
                </h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="componentForm" onsubmit="saveComponent(event)">
                <!-- Basic Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="comp_name" class="block text-sm font-medium text-gray-700 mb-2">
                            Nombre *
                        </label>
                        <input type="text" id="comp_name" name="name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Ej: Tabla de Usuarios">
                    </div>
                    
                    <div>
                        <label for="comp_business_id" class="block text-sm font-medium text-gray-700 mb-2">
                            Business *
                        </label>
                        <select id="comp_business_id" name="business_id" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleccionar business...</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="comp_description" class="block text-sm font-medium text-gray-700 mb-2">
                        Descripción
                    </label>
                    <textarea id="comp_description" name="description" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Descripción del componente"></textarea>
                </div>
                
                <!-- Component Configuration -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="comp_type" class="block text-sm font-medium text-gray-700 mb-2">
                            Tipo de Componente *
                        </label>
                        <select id="comp_type" name="component_type" required onchange="updateComponentPreview()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleccionar tipo...</option>
                            <option value="table">Tabla</option>
                            <option value="cards">Cards</option>
                            <option value="chart">Gráfico</option>
                            <option value="metric">Métrica</option>
                            <option value="list">Lista</option>
                            <option value="dashboard">Dashboard</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="comp_api_id" class="block text-sm font-medium text-gray-700 mb-2">
                            API Source *
                        </label>
                        <select id="comp_api_id" name="api_id" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleccionar API...</option>
                            <option value="jsonplaceholder_users_mvp">JSONPlaceholder Users (Demo)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Layout Configuration -->
                <div class="mb-6">
                    <h4 class="text-md font-medium text-gray-900 mb-3">Configuración de Layout</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="layout_type" class="block text-sm font-medium text-gray-700 mb-2">
                                Ubicación
                            </label>
                            <select id="layout_type" name="layout_type"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="tab">Solo Tab</option>
                                <option value="widget">Solo Widget</option>
                                <option value="page">Página Completa</option>
                                <option value="tab_and_widget">Tab + Widget</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="flex items-center mt-7">
                                <input type="checkbox" id="auto_refresh" name="auto_refresh" checked class="mr-2">
                                <span class="text-sm text-gray-700">Auto-actualizar</span>
                            </label>
                        </div>
                        
                        <div>
                            <label for="refresh_interval" class="block text-sm font-medium text-gray-700 mb-2">
                                Intervalo (seg)
                            </label>
                            <input type="number" id="refresh_interval" name="refresh_interval" value="300" min="30"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- Component Preview -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h4 class="text-sm font-medium text-gray-900 mb-2">Vista Previa del Componente</h4>
                    <div id="component-preview" class="text-center text-gray-500 py-4">
                        Selecciona un tipo de componente para ver la vista previa
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" id="saveCompButton"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Crear Componente
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.tab-button {
    @apply py-2 px-4 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300;
}

.tab-button.active {
    @apply border-blue-500 text-blue-600;
}

.component-card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.component-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
</style>

<script>
let components = [];
let businesses = [];
let currentFilter = 'all';

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadBusinesses();
    loadComponents();
});

async function loadBusinesses() {
    try {
        const response = await fetch('/api/admin/businesses');
        const data = await response.json();
        
        if (data.success) {
            businesses = data.data;
            
            const select = document.getElementById('comp_business_id');
            select.innerHTML = '<option value="">Seleccionar business...</option>';
            
            businesses.forEach(business => {
                const option = document.createElement('option');
                option.value = business.business_id;
                option.textContent = business.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading businesses:', error);
    }
}

async function loadComponents() {
    const container = document.getElementById('components-container');
    
    try {
        // Para MVP, mostrar componentes de ejemplo
        components = [
            {
                component_id: "users_table_mvp",
                name: "Tabla de Usuarios API",
                description: "Tabla que muestra usuarios desde JSONPlaceholder",
                component_type: "table",
                layout_type: "tab_and_widget",
                business_id: "telconorte_isp",
                api_id: "jsonplaceholder_users_mvp",
                is_active: true,
                auto_refresh: true,
                refresh_interval_seconds: 300
            }
        ];
        
        renderComponents();
    } catch (error) {
        container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-yellow-400 text-2xl mb-2"></i>
                <p class="text-yellow-600">Error de conexión: ${error.message}</p>
            </div>
        `;
    }
}

function renderComponents() {
    const container = document.getElementById('components-container');
    
    // Filter components
    const filteredComponents = currentFilter === 'all' 
        ? components 
        : components.filter(comp => comp.component_type === currentFilter);
    
    if (filteredComponents.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-puzzle-piece text-gray-400 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No hay componentes</h3>
                <p class="text-gray-500 mb-4">Crea tu primer componente dinámico</p>
                <button onclick="showCreateModal()" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>
                    Crear Componente
                </button>
            </div>
        `;
        return;
    }
    
    const html = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${filteredComponents.map(comp => `
                <div class="component-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-${getComponentIcon(comp.component_type)} text-blue-600"></i>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-900">${comp.name}</h3>
                                <p class="text-xs text-gray-500">${comp.component_type}</p>
                            </div>
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="testComponent('${comp.component_id}')" 
                                    class="text-green-600 hover:text-green-800 text-sm">
                                <i class="fas fa-play"></i>
                            </button>
                            <button onclick="editComponent('${comp.component_id}')" 
                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteComponent('${comp.component_id}')" 
                                    class="text-red-600 hover:text-red-800 text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <p class="text-xs text-gray-600 mb-3">${comp.description || 'Sin descripción'}</p>
                    
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <div class="flex items-center">
                            <span class="px-2 py-1 bg-gray-100 rounded">
                                ${comp.layout_type.replace('_', ' + ')}
                            </span>
                        </div>
                        <div class="flex items-center">
                            ${comp.auto_refresh ? `
                                <i class="fas fa-sync-alt mr-1"></i>
                                ${comp.refresh_interval_seconds}s
                            ` : `
                                <i class="fas fa-pause mr-1"></i>
                                Manual
                            `}
                        </div>
                    </div>
                    
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">API: ${comp.api_id.substring(0, 15)}...</span>
                            <span class="px-2 py-1 text-xs rounded-full ${comp.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${comp.is_active ? 'Activo' : 'Inactivo'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    container.innerHTML = html;
}

function getComponentIcon(type) {
    const icons = {
        'table': 'table',
        'cards': 'th-large',
        'chart': 'chart-bar',
        'metric': 'calculator',
        'list': 'list',
        'dashboard': 'tachometer-alt'
    };
    return icons[type] || 'puzzle-piece';
}

function filterComponents(filter) {
    currentFilter = filter;
    
    // Update active tab
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
    
    renderComponents();
}

function updateComponentPreview() {
    const type = document.getElementById('comp_type').value;
    const preview = document.getElementById('component-preview');
    
    if (!type) {
        preview.innerHTML = 'Selecciona un tipo de componente para ver la vista previa';
        return;
    }
    
    const previews = {
        'table': `
            <div class="border rounded p-3">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-medium">Tabla de Datos</h4>
                    <i class="fas fa-table text-blue-500"></i>
                </div>
                <div class="text-xs text-gray-500">
                    Muestra datos en formato tabular con paginación, filtros y búsqueda
                </div>
            </div>
        `,
        'cards': `
            <div class="border rounded p-3">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-medium">Vista de Cards</h4>
                    <i class="fas fa-th-large text-green-500"></i>
                </div>
                <div class="text-xs text-gray-500">
                    Presenta datos en formato de tarjetas responsivas
                </div>
            </div>
        `,
        'chart': `
            <div class="border rounded p-3">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-medium">Gráfico</h4>
                    <i class="fas fa-chart-bar text-purple-500"></i>
                </div>
                <div class="text-xs text-gray-500">
                    Visualiza datos en gráficos de barras, líneas o torta
                </div>
            </div>
        `
    };
    
    preview.innerHTML = previews[type] || 'Vista previa no disponible';
}

function showCreateModal() {
    document.getElementById('componentForm').reset();
    document.getElementById('auto_refresh').checked = true;
    document.getElementById('refresh_interval').value = '300';
    updateComponentPreview();
    document.getElementById('componentModal').classList.remove('hidden');
}

async function testComponent(componentId) {
    try {
        // Simular test del componente
        const comp = components.find(c => c.component_id === componentId);
        if (comp) {
            showMessage('success', `Componente "${comp.name}" probado exitosamente - 10 registros obtenidos`);
        }
    } catch (error) {
        showMessage('error', `Error probando componente: ${error.message}`);
    }
}

function editComponent(componentId) {
    showMessage('info', 'Función de edición disponible en la versión completa');
}

function deleteComponent(componentId) {
    if (confirm('¿Estás seguro de que quieres eliminar este componente?')) {
        showMessage('success', 'Componente eliminado (simulado)');
        // En la versión real, aquí se haría la llamada DELETE
    }
}

async function saveComponent(event) {
    event.preventDefault();
    
    const saveButton = document.getElementById('saveCompButton');
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creando...';
    saveButton.disabled = true;
    
    try {
        // Simular creación del componente
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        closeModal();
        showMessage('success', 'Componente creado exitosamente');
        loadComponents(); // Reload
        
    } catch (error) {
        showMessage('error', `Error: ${error.message}`);
    } finally {
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
    }
}

function closeModal() {
    document.getElementById('componentModal').classList.add('hidden');
}

function showMessage(type, text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `flash-message mb-4 px-4 py-3 rounded ${
        type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' : 
        type === 'info' ? 'bg-blue-100 border border-blue-400 text-blue-700' :
        'bg-green-100 border border-green-400 text-green-700'
    }`;
    messageDiv.textContent = text;
    
    const content = document.querySelector('.space-y-6');
    content.insertBefore(messageDiv, content.firstChild);
    
    setTimeout(() => {
        messageDiv.style.opacity = '0';
        setTimeout(() => messageDiv.remove(), 500);
    }, 5000);
}

// Close modal when clicking outside
document.getElementById('componentModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}
