<!-- ================================ -->
<!-- app/frontend/templates/dashboard.html -->
<!-- ================================ -->

{% extends "base.html" %}

{% block title %}Dashboard - CMS Dinámico{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                Dashboard
                {% if business_info %}
                    - {{ business_info.name }}
                {% endif %}
            </h2>
            <p class="text-sm text-gray-500 mt-1">
                Bienvenido {{ user.name }}, aquí tienes un resumen del sistema
            </p>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
            <button onclick="location.reload()" class="btn btn-secondary">
                <i class="fas fa-sync-alt mr-2"></i>
                Actualizar
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
        <!-- Business Types -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-shapes text-blue-400 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                Business Types
                            </dt>
                            <dd class="text-lg font-medium text-gray-900" id="stat-business-types">
                                {{ stats.total_business_types or 0 }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Business Instances -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-building text-green-400 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                Businesses
                            </dt>
                            <dd class="text-lg font-medium text-gray-900" id="stat-businesses">
                                {{ stats.total_business_instances or 0 }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Configurations -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-plug text-yellow-400 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                APIs Configuradas
                            </dt>
                            <dd class="text-lg font-medium text-gray-900" id="stat-apis">
                                {{ stats.total_api_configurations or 0 }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Components -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-puzzle-piece text-purple-400 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">
                                Componentes
                            </dt>
                            <dd class="text-lg font-medium text-gray-900" id="stat-components">
                                {{ stats.total_dynamic_components or 0 }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Tabs -->
    <div class="bg-white shadow rounded-lg">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex" id="dashboard-tabs">
                <button onclick="showTab('overview')" class="tab-button active" data-tab="overview">
                    <i class="fas fa-chart-line mr-2"></i>
                    Resumen
                </button>
                <button onclick="showTab('components')" class="tab-button" data-tab="components">
                    <i class="fas fa-puzzle-piece mr-2"></i>
                    Componentes Activos
                </button>
                <button onclick="showTab('recent-activity')" class="tab-button" data-tab="recent-activity">
                    <i class="fas fa-clock mr-2"></i>
                    Actividad Reciente
                </button>
            </nav>
        </div>

        <div class="p-6">
            <!-- Overview Tab -->
            <div id="tab-overview" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- System Status -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">
                            <i class="fas fa-heartbeat mr-2"></i>
                            Estado del Sistema
                        </h3>
                        <div class="space-y-3" id="system-status">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">MongoDB</span>
                                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Conectado</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">API Backend</span>
                                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Funcionando</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Cache System</span>
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">Simulado</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">
                            <i class="fas fa-bolt mr-2"></i>
                            Acciones Rápidas
                        </h3>
                        <div class="grid grid-cols-2 gap-3">
                            {% if user.role in ['super_admin', 'admin'] %}
                            <a href="/business-types" class="text-center p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                <i class="fas fa-plus text-blue-500 text-xl mb-2"></i>
                                <div class="text-sm font-medium">Nuevo Business Type</div>
                            </a>
                            <a href="/businesses" class="text-center p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                <i class="fas fa-building text-green-500 text-xl mb-2"></i>
                                <div class="text-sm font-medium">Nuevo Business</div>
                            </a>
                            <a href="/api-configs" class="text-center p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                <i class="fas fa-plug text-yellow-500 text-xl mb-2"></i>
                                <div class="text-sm font-medium">Configurar API</div>
                            </a>
                            {% endif %}
                            <a href="/components" class="text-center p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                <i class="fas fa-puzzle-piece text-purple-500 text-xl mb-2"></i>
                                <div class="text-sm font-medium">Nuevo Componente</div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Components Tab -->
            <div id="tab-components" class="tab-content hidden">
                <div class="space-y-4" id="active-components">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <div>Cargando componentes activos...</div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Tab -->
            <div id="tab-recent-activity" class="tab-content hidden">
                <div class="space-y-4" id="recent-activity">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <div>Cargando actividad reciente...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.tab-button {
    @apply py-2 px-4 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300;
}

.tab-button.active {
    @apply border-blue-500 text-blue-600;
}

.tab-content.hidden {
    display: none;
}
</style>

<script>
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`tab-${tabName}`).classList.remove('hidden');
    
    // Add active class to selected button
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // Load tab content
    loadTabContent(tabName);
}

async function loadTabContent(tabName) {
    if (tabName === 'components') {
        await loadActiveComponents();
    } else if (tabName === 'recent-activity') {
        await loadRecentActivity();
    }
}

async function loadActiveComponents() {
    const container = document.getElementById('active-components');
    container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>';
    
    try {
        const response = await fetch('/api/admin/stats');
        const data = await response.json();
        
        if (data.success) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-puzzle-piece text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium mb-2">Componentes Activos</h3>
                    <p>Total de componentes configurados: ${data.data.total_dynamic_components || 0}</p>
                    <div class="mt-4">
                        <a href="/components" class="btn btn-primary">
                            Ver Todos los Componentes
                        </a>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = '<div class="text-red-500">Error cargando componentes</div>';
    }
}

async function loadRecentActivity() {
    const container = document.getElementById('recent-activity');
    container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>';
    
    try {
        const response = await fetch('/api/admin/logs/recent?limit=10');
        const data = await response.json();
        
        if (data.success && data.data.length > 0) {
            const logHtml = data.data.map(log => `
                <div class="border-l-4 ${log.success ? 'border-green-400' : 'border-red-400'} pl-4 py-2">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-900">
                                ${log.request_method} ${log.api_id || 'Sistema'}
                            </p>
                            <p class="text-xs text-gray-500">
                                ${new Date(log.timestamp).toLocaleString()}
                            </p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full ${log.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${log.success ? 'Éxito' : 'Error'}
                        </span>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = logHtml;
        } else {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-clock text-4xl mb-4"></i>
                    <p>No hay actividad reciente registrada</p>
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = '<div class="text-red-500">Error cargando actividad</div>';
    }
}

// Load stats on page load
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/api/admin/stats');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('stat-business-types').textContent = data.data.total_business_types || 0;
            document.getElementById('stat-businesses').textContent = data.data.total_business_instances || 0;
            document.getElementById('stat-apis').textContent = data.data.total_api_configurations || 0;
            document.getElementById('stat-components').textContent = data.data.total_dynamic_components || 0;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
});
</script>
{% endblock %}